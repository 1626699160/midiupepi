<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mediapipe æ‰‹åŠ¿è¯†åˆ«</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }

        h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
        }

        video, canvas {
            width: 100%;
            max-width: 320px;
            height: auto;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #000;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }

        button:hover {
            background-color: #45a049;
        }

        #gesture-result {
            font-size: 20px;
            font-weight: bold;
            color: #ff5722;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h2>Mediapipe æ‰‹åŠ¿è¯†åˆ« - Ubuntu</h2>
    <video id="video" autoplay playsinline></video>
    <canvas id="output"></canvas>
    <br><br>
    <button onclick="startCamera()">æ‰“å¼€æ‘„åƒå¤´</button>
    <div id="gesture-result">è¯†åˆ«æ‰‹åŠ¿: æ— </div>

    <script>
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('output');
        const canvasCtx = canvasElement.getContext('2d');
        const gestureResult = document.getElementById("gesture-result");

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`,
        });

        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5,
        });

        hands.onResults(results => {
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

            let detectedGesture = "æ— ";

            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, { color: '#00FF00', lineWidth: 2 });
                    drawLandmarks(canvasCtx, landmarks, { color: '#FF0000', lineWidth: 1 });

                    // è¯†åˆ«æ‰‹åŠ¿
                    detectedGesture = recognizeGesture(landmarks);
                }
            }

            // æ›´æ–°æ‰‹åŠ¿è¯†åˆ«ç»“æœ
            gestureResult.innerText = "è¯†åˆ«æ‰‹åŠ¿: " + detectedGesture;
        });

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    videoElement.srcObject = stream;
                    videoElement.onloadedmetadata = () => {
                        const videoWidth = videoElement.videoWidth;
                        const videoHeight = videoElement.videoHeight;

                        canvasElement.width = videoWidth;
                        canvasElement.height = videoHeight;
                        videoElement.width = videoWidth;
                        videoElement.height = videoHeight;

                        processVideo();
                    };
                })
                .catch(error => {
                    alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–è®¾å¤‡è¿æ¥ã€‚\né”™è¯¯ä¿¡æ¯ï¼š" + error.message);
                    console.error("æ‘„åƒå¤´é”™è¯¯:", error);
                });
        }

        function processVideo() {
            async function detectHands() {
                await hands.send({ image: videoElement });
                requestAnimationFrame(detectHands);
            }
            detectHands();
        }

        function recognizeGesture(landmarks) {
            const thumbTip = landmarks[4];
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const ringTip = landmarks[16];
            const pinkyTip = landmarks[20];

            const indexPIP = landmarks[6];
            const middlePIP = landmarks[10];
            const ringPIP = landmarks[14];
            const pinkyPIP = landmarks[18];

            // è®¡ç®—æ‹‡æŒ‡å’Œé£ŸæŒ‡çš„æ¬§å‡ é‡Œå¾—è·ç¦»
            const thumbIndexDistance = Math.sqrt(
                Math.pow(thumbTip.x - indexTip.x, 2) +
                Math.pow(thumbTip.y - indexTip.y, 2) +
                Math.pow(thumbTip.z - indexTip.z, 2)  // è®¡ç®— Z è½´ï¼Œæé«˜ç«‹ä½“è¯†åˆ«
            );

            // åˆ¤æ–­æ‰‹æŒ‡æ˜¯å¦ä¼¸ç›´
            const isIndexStraight = indexTip.y < indexPIP.y;
            const isMiddleStraight = middleTip.y < middlePIP.y;
            const isRingStraight = ringTip.y < ringPIP.y;
            const isPinkyStraight = pinkyTip.y < pinkyPIP.y;

            // è®¡ç®—æ‰‹æŒ‡é—´æ¨ªå‘é—´è·ï¼Œæå‡â€œå¼ å¼€æ‰‹æŒâ€æ£€æµ‹
            const indexMiddleDistance = Math.abs(indexTip.x - middleTip.x);
            const middleRingDistance = Math.abs(middleTip.x - ringTip.x);
            const ringPinkyDistance = Math.abs(ringTip.x - pinkyTip.x);
            
            // è¯†åˆ« OK æ‰‹åŠ¿ ğŸ‘Œï¼ˆæ‹‡æŒ‡å’Œé£ŸæŒ‡é—­åˆï¼Œå…¶ä»–æ‰‹æŒ‡ä¼¸ç›´ï¼‰
            if (thumbIndexDistance < 0.05 && 
                isMiddleStraight && isRingStraight && isPinkyStraight &&
                thumbTip.x < indexTip.x) { // ç¡®ä¿æ‹‡æŒ‡ç›¸å¯¹é£ŸæŒ‡æ­£ç¡®ä½ç½®
                return "OK ğŸ‘Œ";
            }

            // è¯†åˆ«ç‚¹èµ ğŸ‘ï¼ˆå¤§æ‹‡æŒ‡æœä¸Šï¼Œå…¶ä»–æ‰‹æŒ‡å¼¯æ›²ï¼‰
            if (thumbTip.y < indexTip.y && 
                thumbTip.x > indexPIP.x && // ç¡®ä¿æ‹‡æŒ‡ä¸åœ¨æŒå¿ƒåŒºåŸŸ
                !isIndexStraight && !isMiddleStraight && !isRingStraight && !isPinkyStraight) {
                return "ç‚¹èµ ğŸ‘";
            }

            // è¯†åˆ«æ•°å­— 1 â˜ï¸ï¼ˆä»…é£ŸæŒ‡ä¼¸ç›´ï¼‰
            if (isIndexStraight && !isMiddleStraight && !isRingStraight && !isPinkyStraight) {
                return "æ•°å­— 1 â˜ï¸";
            }

            // è¯†åˆ«å‰ªåˆ€ âœŒï¸ï¼ˆé£ŸæŒ‡å’Œä¸­æŒ‡ä¼¸ç›´ï¼Œå…¶ä½™å¼¯æ›²ï¼‰
            if (isIndexStraight && isMiddleStraight && !isRingStraight && !isPinkyStraight) {
                return "å‰ªåˆ€ âœŒï¸";
            }

            // è¯†åˆ«æ•°å­— 2 âœŒï¸ï¼ˆå’Œå‰ªåˆ€ç±»ä¼¼ï¼Œä½†æ‹‡æŒ‡æ”¶èµ·ï¼‰
            if (isIndexStraight && isMiddleStraight && !isRingStraight && !isPinkyStraight && thumbTip.y > indexPIP.y) {
                return "æ•°å­— 2 âœŒï¸";
            }

            // è¯†åˆ«å¼ å¼€æ‰‹æŒ âœ‹ï¼ˆæ‰€æœ‰æ‰‹æŒ‡ä¼¸ç›´ï¼Œä¸”æŒ‡é—´è·ç¦»è¾ƒå¤§ï¼‰
            if (isIndexStraight && isMiddleStraight && isRingStraight && isPinkyStraight &&
                indexMiddleDistance > 0.03 && middleRingDistance > 0.03 && ringPinkyDistance > 0.03) {
                return "å¼ å¼€æ‰‹æŒ âœ‹";
            }

            // è¯†åˆ«æ‹³å¤´ ğŸ‘Šï¼ˆæ‰€æœ‰æ‰‹æŒ‡å¼¯æ›²ï¼‰
            if (   !isIndexStraight && !isMiddleStraight && !isRingStraight && !isPinkyStraight) {
                return "æ‹³å¤´ ğŸ‘Š";
            }

            return "æœªçŸ¥æ‰‹åŠ¿";
        }
    </script>
</body>
</html>
